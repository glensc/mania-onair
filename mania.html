<head>
<title>Radiomania eeter</title>
<link rel="shortcut icon" id="icon" href="http://www.mania.ee/templates/mania/images/favicon.ico">
<style>
body {
	background-color: #000;
	color: #fff;
	font-family: Verdana, Arial, Helvetica;
	font-size: 20pt;
}
#log {
	padding-top: 3em;
	font-size: 12px;
}
</style>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
jQuery(function($) {
	var m_url = 'mania.php';
	var m_icon = $('#icon').attr('href');
	var m_title = document.title;
	var notify = function() {};
	var isOnline = ('onLine' in navigator) ? navigator.onLine : 1;

	// setup online/offline event handlers
	// delay update, as chromium catches online state already when only DHCP request is sent out
	$(window)
		.bind('online', function() { isOnline = 1; setTimeout(update, 5000); })
		.bind('offline', function() { isOnline = 0; });

	// http://www.chromium.org/developers/design-documents/desktop-notifications/api-specification
	if (window.webkitNotifications) {
		var Notifications = webkitNotifications;
		notify = function(icon, title, content) {
			if (Notifications.checkPermission() == 0) {
				var object = Notifications.createNotification(icon, title, content);
				object.show();
				object.ondisplay = function() {
					// hide after 5 seconds
					setTimeout(function() { object.cancel() }, 5000);
				}
				object.onclick = function() { object.cancel() };
			}
		}

		// setup request permission button if not allowed nor disallowed
		if (!~[0,2].indexOf(Notifications.checkPermission())) {
			$('#request_permission').on('click', function() {
				Notifications.requestPermission(function(f, b) {
					$('#request_permission').css({display:'none'});
					update();
				});
			}).css({display:'block'});
		}
	}

	var $refresh = $('#refresh');
	$refresh.on('click', function() {
		$refresh.attr('disabled', 'disabled');
		update(function(data) {
			$refresh.removeAttr('disabled');
		});
	});

	var cache;
	var $eeter = $("#eeter");
	var $log = $('#log');
	function update_cb(data) {
		// avoid updating if content is the same
		if (cache && cache.time == data.time) {
			return;
		}
		cache = data;

		$eeter.find('#artist').html(data.artist);
		$eeter.find('#title').html(data.title);
		$eeter.find('#time').html(data.time);

		notify(m_icon, m_title, $eeter.text());
		// append to "log"

		$log.append($eeter.text() + '<br/>');
	}

	function update(cb) {
		if (!isOnline) {
			return;
		}

		$.ajax({url: m_url, success: function(data) {
				update_cb(data);
				if (cb) {
					cb(data);
				}
			}
		});
	}

	update();
	setInterval(update, 30000);
});
</script>
</head>
<body>

<div id="eeter">
	<span id="time"></span>
	<b id="artist"></b><br/>
	<span id="title"></span><br/>
</div>

<button id="request_permission" href="#" style="display: none">Set notification permissions for this page</button>
<button id="refresh">Refresh</button>

<div id="log">
</div>

</body>
</html>
